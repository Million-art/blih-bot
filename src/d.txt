const TelegramBot = require('node-telegram-bot-api');
const mysql = require('mysql');
const bot = new TelegramBot('YOUR_TELEGRAM_BOT_TOKEN', { polling: true });
const connection = mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: '',
  database: 'telegrambot',
});

// Start command handler
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;

  // Create the keyboard markup
  const keyboard = {
    reply_markup: {
      keyboard: [['Login'], ['Signup']],
      one_time_keyboard: true,
    },
  };

  // Send the keyboard to the user
  bot.sendMessage(chatId, 'Choose an option:', keyboard);
});

// Login handler
bot.onText(/Login/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;

  // Check if the user is registered in the database
  connection.query('SELECT * FROM users WHERE user_id = ?', [userId], (error, results) => {
    if (error) throw error;
    if (results.length > 0) {
      const username = results[0].username;
      bot.sendMessage(chatId, `Welcome back, ${username}!`);
    } else {
      bot.sendMessage(chatId, 'You are not registered! please register first');
      bot.sendMessage(chatId, 'Choose an option:', keyboard);

    }
  });
});

// Signup handler
bot.onText(/Signup/, (msg) => {
  const chatId = msg.chat.id;

  // Send the registration form step by step
 
      bot.sendMessage(chatId, 'Please enter your first name:');
      bot.once('message', (firstNameMsg) => {
        const firstName = firstNameMsg.text;
        bot.sendMessage(chatId, 'Please enter your last name:');
        bot.once('message', (lastNameMsg) => {
          const lastName = lastNameMsg.text;
          bot.sendMessage(chatId, 'Please enter your phone number:');
          bot.once('message', (phoneMsg) => {
            const phoneNumber = phoneMsg.text;
            bot.sendMessage(chatId, 'Please enter your email:');
            bot.once('message', (emailMsg) => {
              const email = emailMsg.text;
              bot.sendMessage(chatId, 'Please enter your birth date (YYYY-MM-DD):');
              bot.once('message', (birthDateMsg) => {
                const birthDate = birthDateMsg.text;
                bot.sendMessage(chatId, 'Please enter your company name:');
                bot.once('message', (companyNameMsg) => {
                  const companyName = companyNameMsg.text;

                  // Insert user data into the database
                  connection.query(
                    'INSERT INTO users (user_id, first_name, last_name, phone_number, email, birth_date, company_name) VALUES (?, ?, ?, ?, ?, ?, ?)',
                    [userId, firstName, lastName, phoneNumber, email, birthDate, companyName],
                    (error) => {
                      if (error) throw error;
                      bot.sendMessage(chatId, 'Registration successful!');
                    }
                  );
                });
              });
            });
          });
        });
      });
    
});

// Step 1: First name
bot.onText(/\/step1/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, 'Please enter your first name:');
});

// Step 2: Last name
bot.onText(/\/step2/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, 'Please enter your last name:');
});

// Step 3: Phone number
bot.onText(/\/step3/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, 'Please enter your phone number:');
});

// Step 4: Email
bot.onText(/\/step4/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, 'Please enter your email:');
});

// Step 5: Birth date
bot.onText(/\/step5/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, 'Please enter your birth date (YYYY-MM-DD):');
});

// Step 6: Company name
bot.onText(/\/step6/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, 'Please enter your company name:');
});

// Handle user input for each step of the registration process
bot.on('message', (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const step = msg.text.toLowerCase();

  switch (step) {
    case 'please enter your first name:':
      // Handle first name input
      // Save the first name to the database or perform any necessary validation
      bot.sendMessage(chatId, 'Please enter your last name:');
      break;
    case 'please enter your last name:':
      // Handle last name input
      // Save the last name to the database or perform any necessary validation
      bot.sendMessage(chatId, 'Please enter your phone number:');
      break;
    case 'please enter your phone number:':
      // Handle phone number input
      // Save the phone number to the database or perform any necessary validation
      bot.sendMessage(chatId, 'Please enter your email:');
      break;
    case 'please enter your email:':
      // Handle email input
      // Save the email to the database or perform any necessary validation
      bot.sendMessage(chatId, 'Please enter your birth date (YYYY-MM-DD):');
      break;
    case 'please enter your birth date (yyyy-mm-dd):':
      // Handle birth date input
      // Save the birth date to the database or perform any necessary validation
      bot.sendMessage(chatId, 'Please enter your company name:');
      break;
    case 'please enter your company name:':
      // Handle company name input
      // Save the company name to the database or perform any necessary validation
      bot.sendMessage(chatId, 'Registration successful!');
      break;
    default:
      break;
  }
});

bot.on('polling_error', (error) => {
  console.log(error);
});

connection.connect((error) => {
  if (error) throw error;
  console.log('Connected to MySQL database.');
});